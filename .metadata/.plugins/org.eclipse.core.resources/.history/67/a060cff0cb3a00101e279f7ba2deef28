/*
 * bme280_port.c
 *
 *  Created on: May 26, 2025
 *      Author: danilo
 */


#include "bme280.h"
#include "stm32f4xx_hal.h"
#include "bme280_port.h"
#include "cmsis_os.h"

extern SPI_HandleTypeDef hspi2;

#define CS_LOW()  HAL_GPIO_WritePin(GPIOE, GPIO_PIN_14, GPIO_PIN_RESET)
#define CS_HIGH() HAL_GPIO_WritePin(GPIOE, GPIO_PIN_14, GPIO_PIN_SET)

// SPI read
BME280_INTF_RET_TYPE user_spi_read(uint8_t reg_addr, uint8_t *data, uint32_t len, void *intf_ptr) {
    CS_LOW();
    uint8_t addr = reg_addr | 0x80;
    HAL_SPI_Transmit(&hspi2, &addr, 1, HAL_MAX_DELAY);
    HAL_SPI_Receive(&hspi2, data, len, HAL_MAX_DELAY);
    CS_HIGH();
    return 0;
}

// SPI write
BME280_INTF_RET_TYPE user_spi_write(uint8_t reg_addr, const uint8_t *data, uint32_t len, void *intf_ptr) {
    CS_LOW();
    uint8_t addr = reg_addr & 0x7F;
    HAL_SPI_Transmit(&hspi2, &addr, 1, HAL_MAX_DELAY);
    HAL_SPI_Transmit(&hspi2, (uint8_t*)data, len, HAL_MAX_DELAY);
    CS_HIGH();
    return 0;
}

// Delay function
void user_delay_ms(uint32_t period, void *intf_ptr) {
    osDelay(period);
}
